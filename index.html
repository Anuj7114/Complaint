<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CableTV Complaint System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { max-width: 480px; margin: 0 auto; background: #f3f4f6; font-family: 'Roboto', Arial, sans-serif; color: #111; font-size: 17px; padding-bottom: 70px;}
    header { background: #2563eb; color: #fff; padding: 15px 0 13px 0; font-size: 20px; font-weight: bold; letter-spacing: .01em; text-align: center; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 9px rgba(0,0,0,0.07); display: flex; align-items: center; justify-content: center; gap: 8px;}
    header .material-icons { font-size: 28px; }
    main {padding: 16px;}
    .btn { width: 100%; padding: 16px 0; margin: 18px 0 10px 0; background: linear-gradient(90deg,#2563eb 60%,#38bdf8); color: #fff; font-weight: bold; font-size: 19px; border: none; border-radius: 16px; box-shadow: 0 2px 7px rgba(37,99,235,0.10); display: flex; align-items: center; justify-content: center; gap: 10px; transition: background .17s, transform .13s; outline: none; touch-action: manipulation; user-select: none; letter-spacing: .01em; cursor: pointer;}
    .btn:active { background: #2563eb; transform: scale(0.97);}
    .form-section { background: #fff; border-radius: 15px; box-shadow: 0 1px 11px rgba(0,0,0,0.11); margin: 21px 0; padding: 17px 14px 8px 14px; font-size:17px;}
    .form-section label {font-weight:500;display:block;margin: 5px 0 2px 2px;}
    .form-section input, .form-section select, .form-section textarea { width: 100%; font-size: 16px; border: 1.3px solid #d1d5db; border-radius: 9px; padding: 10px 9px; margin-bottom: 7px; background: #f9fafb; color: #333; box-sizing: border-box;}
    .form-section textarea {resize:vertical;}
    .form-section .row {display:flex;gap:9px;}
    .form-section .row > div {flex:1;}
    .form-section .form-actions { display:flex;justify-content:flex-end;gap:12px;padding:14px 0 7px 0;}
    .form-section .form-btn { padding:10px 23px; background:#2563eb; border:none; border-radius:8px; color:#fff; font-weight:700; font-size:18px; letter-spacing:0.01em;}
    .form-section .form-btn.cancel { background: #e5e7eb; color: #374151; font-weight: 600;}
    .autocomplete-container { position: relative; width: 100%; }
    .autocomplete-items { position: absolute; left: 0; right: 0; top: 100%; z-index: 1000; background: #fff; border: 1.2px solid #d1d5db; max-height: 180px; overflow-y: auto; border-radius: 9px; margin-top: 2px;}
    .autocomplete-item { padding:13px 15px; font-size:1em; cursor:pointer;}
    .autocomplete-item:active, .autocomplete-active {background:#e0e7ef;}
    .hidden {display:none !important;}
    .dashboard-section {background: #fff; border-radius: 15px; box-shadow: 0 1px 11px rgba(0,0,0,0.11); padding: 11px 5px 7px 5px; margin-bottom: 17px;}
    .dashboard-header {display: flex; align-items:center; justify-content: space-between; margin-bottom: 5px;}
    .dashboard-header h2 {font-size: 19px; margin: 0; font-weight: bold;}
    .dashboard-header .refresh-btn {background: none; border: none; color: #2563eb; font-size: 25px; cursor:pointer;}
    .search-bar { width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    .search-bar input, .search-bar select { width: 32%; margin: 0 2px 7px 0; display: inline-block;}
    .complaints-table { width: 100%; border-collapse: collapse; font-size: 15px;}
    .complaints-table th, .complaints-table td { padding: 7px 4px; text-align: left; border-bottom: 1px solid #e5e7eb;}
    .complaints-table th { font-weight:700; background: #f3f4f6;}
    .complaint-status { font-weight: bold; border-radius: 5px; padding:2px 7px;}
    .complaint-status.Pending { color: #fff; background: #f59e42;}
    .complaint-status.Resolved { color: #fff; background: #22c55e;}
    .action-btn { background: none; border: none; cursor: pointer; color: #2563eb; font-size:19px;}
    .action-btn[disabled] { color: #bbb; cursor: not-allowed;}
    @media (max-width: 390px) {
      .complaints-table th, .complaints-table td {font-size: 13px;}
      .dashboard-header h2 {font-size: 16px;}
    }
  </style>
</head>
<body>
  <header>
    <i class="material-icons">tv</i>
    CableTV Complaint System
  </header>
  <main>
    <section id="dashboardSection" class="dashboard-section">
      <div class="dashboard-header">
        <h2>Recent Complaints</h2>
        <button class="refresh-btn" id="refreshComplaintsBtn" title="Refresh complaints"><i class="material-icons">refresh</i></button>
      </div>
      <div class="search-bar">
        <input id="searchName" type="text" placeholder="Search Name">
        <input id="searchType" type="text" placeholder="Type">
        <select id="searchStatus">
          <option value="">Status</option>
          <option>Pending</option>
          <option>Resolved</option>
        </select>
      </div>
      <div style="overflow-x:auto;">
        <table class="complaints-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Status</th>
              <th>Time</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="complaintsTableBody">
            <tr><td colspan="5" style="text-align:center; color:#aaa;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
    <button id="registerComplaintBtn" class="btn"><i class="material-icons">add_circle_outline</i>Register Complaint</button>
    <section id="complaintFormSection" class="form-section hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2 style="font-size:18px;margin:0;font-weight:bold;">Register Complaint</h2>
        <button id="closeFormBtn" style="background:none;border:none;color:#374151;font-size:23px;"><i class="material-icons">close</i></button>
      </div>
      <form id="complaintFormElement" autocomplete="off" style="margin-top:4px;">
        <div class="autocomplete-container">
          <label for="customerSearchInput">Customer Name</label>
          <input id="customerSearchInput" name="name" type="text" placeholder="Type to search customer name..." autocomplete="name" required>
          <div id="customerAutocompleteList" class="autocomplete-items" style="display:none;"></div>
        </div>
        <label for="stbNumber">STB Number</label>
        <input id="stbNumber" name="stbNumber" type="text" autocomplete="off" readonly>
        <label for="complaintType">Complaint Type</label>
        <select id="complaintType" name="complaintType" autocomplete="off" required>
          <option value="">Select complaint type</option>
          <option>Channel Freezing</option>
          <option>No Sound</option>
          <option>No video</option>
          <option>Loose Connection</option>
          <option>Complete Dead</option>
          <option>No Signal</option>
          <option>New Connection Request</option>
          <option>Payment Collection Request</option>
          <option>Connection Shifting Request</option>
          <option>Main Line Breakdown Road</option>
          <option>Wire Shifting</option>
          <option>New Remote</option>
          <option>New Adapter</option>
          <option>Other</option>
        </select>
        <label for="comments">Comments (Optional)</label>
        <textarea id="comments" name="comments" rows="2" placeholder="Add any additional details..." autocomplete="off"></textarea>
        <label for="customerAddress">Customer Address</label>
        <textarea id="customerAddress" name="address" rows="2" autocomplete="street-address" readonly></textarea>
        <div class="row">
          <div>
            <label for="customerLocation">Customer Location (GPS)</label>
            <input id="customerLocation" name="gps" type="text" autocomplete="off" readonly>
          </div>
          <div>
            <label for="phone1">Phone 1</label>
            <input id="phone1" name="phone1" type="text" autocomplete="tel" readonly>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="phone2">Phone 2</label>
            <input id="phone2" name="phone2" type="text" autocomplete="tel" readonly>
          </div>
          <div>
            <label for="phone3">Phone 3</label>
            <input id="phone3" name="phone3" type="text" autocomplete="tel" readonly>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" id="cancelComplaintBtn" class="form-btn cancel">Cancel</button>
          <button type="submit" class="form-btn">Submit</button>
        </div>
      </form>
    </section>
    <div id="successMsg" style="display:none;padding:20px 10px 10px 10px;color:#22c55e;font-weight:600;font-size:18px;text-align:center;">
      Complaint Registered Successfully!
    </div>
  </main>
  <script>
    // SheetDB API endpoints -- replace with your actual endpoint if needed
    const SHEETDB_API = "https://sheetdb.io/api/v1/ner9gfv7uhpnb";
    const SHEETDB_CUSTOMERS_API = "https://sheetdb.io/api/v1/f5vg3sptzr3d4";
    // Customer fields (update if Google Sheet headers change)
    const customerFields = {
      stb: "STB Number",
      name: "NAME",
      address: "ADD",
      gps: "GPS",
      phone1: "PHONE 1",
      phone2: "PHONE 2",
      phone3: "PHONE 3"
    };
    // Complaint fields
    const complaintFields = {
      timestamp: "Timestamp",
      name: "Name",
      complaintType: "Complaint Type",
      comments: "Comments",
      stbNumber: "STB Number",
      address: "Address",
      gps: "GPS",
      phone1: "Phone 1",
      phone2: "Phone 2",
      phone3: "Phone 3",
      status: "Status"
    };

    let customerList = [];
    let allComplaints = []; // For dashboard filtering

    // Show/Hide helpers
    function showSection(id) {
      document.getElementById('complaintFormSection').classList.add('hidden');
      document.getElementById('successMsg').style.display = 'none';
      if(id) document.getElementById(id).classList.remove('hidden');
    }

    document.getElementById('registerComplaintBtn').onclick = function() {
      showSection('complaintFormSection');
    };
    document.getElementById('closeFormBtn').onclick =
    document.getElementById('cancelComplaintBtn').onclick = function() {
      showSection();
    };

    // Timestamp format: YYYY-MM-DD HH:mm:ss (local time)
    function getLocalTimestamp() {
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      return [
        now.getFullYear(),
        pad(now.getMonth() + 1),
        pad(now.getDate())
      ].join('-') + ' ' +
      [
        pad(now.getHours()),
        pad(now.getMinutes()),
        pad(now.getSeconds())
      ].join(':');
    }

    // Complaint submit
    document.getElementById('complaintFormElement').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = e.target;
      const payload = {
        data: {
          [complaintFields.timestamp]: getLocalTimestamp(),
          [complaintFields.name]: form.name.value,
          [complaintFields.complaintType]: form.complaintType.value,
          [complaintFields.comments]: form.comments.value,
          [complaintFields.stbNumber]: form.stbNumber.value,
          [complaintFields.address]: form.address.value,
          [complaintFields.gps]: form.gps.value,
          [complaintFields.phone1]: form.phone1.value,
          [complaintFields.phone2]: form.phone2.value,
          [complaintFields.phone3]: form.phone3.value,
          [complaintFields.status]: "Pending"
        }
      };
      await fetch(SHEETDB_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      form.reset();
      showSuccess();
      fetchComplaints(); // Refresh dashboard
    });

    // Show success and hide form
    function showSuccess() {
      document.getElementById('complaintFormSection').classList.add('hidden');
      document.getElementById('successMsg').style.display = '';
      setTimeout(() => {
        document.getElementById('successMsg').style.display = 'none';
      }, 2000);
    }

    // Fetch customers and set up autocomplete
    async function fetchCustomerList() {
      try {
        const res = await fetch(SHEETDB_CUSTOMERS_API);
        customerList = await res.json();
        setupCustomerAutocomplete();
      } catch (e) {
        customerList = [];
        setupCustomerAutocomplete();
      }
    }

    function fillCustomerDetails(customer) {
      document.getElementById('stbNumber').value = customer[customerFields.stb] || "";
      document.getElementById('customerAddress').value = customer[customerFields.address] || "";
      document.getElementById('customerLocation').value = customer[customerFields.gps] || "";
      document.getElementById('phone1').value = customer[customerFields.phone1] || "";
      document.getElementById('phone2').value = customer[customerFields.phone2] || "";
      document.getElementById('phone3').value = customer[customerFields.phone3] || "";
    }

    // AUTOCOMPLETE/SEARCH LOGIC
    function setupCustomerAutocomplete() {
      const input = document.getElementById('customerSearchInput');
      const list = document.getElementById('customerAutocompleteList');
      let activeIndex = -1;
      input.oninput = function() {
        const val = this.value.trim().toLowerCase();
        list.innerHTML = '';
        activeIndex = -1;
        if (!val || customerList.length === 0) {
          list.style.display = 'none';
          return;
        }
        const nameKey = customerFields.name;
        const matches = customerList.filter(c =>
          (c[nameKey] || "").toLowerCase().includes(val)
        );
        if (matches.length === 0) {
          list.style.display = 'none';
          return;
        }
        matches.slice(0, 20).forEach((c, idx) => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.textContent = c[nameKey];
          item.tabIndex = -1;
          item.onmousedown = function(e) {
            e.preventDefault();
            input.value = c[nameKey];
            fillCustomerDetails(c);
            list.innerHTML = '';
            list.style.display = 'none';
          };
          list.appendChild(item);
        });
        list.style.display = '';
      };
      input.onkeydown = function(e) {
        let items = list.querySelectorAll('.autocomplete-item');
        if (!items.length) return;
        if (e.key === "ArrowDown") {
          e.preventDefault();
          activeIndex = (activeIndex + 1) % items.length;
          updateActive(items, activeIndex);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          activeIndex = (activeIndex - 1 + items.length) % items.length;
          updateActive(items, activeIndex);
        } else if (e.key === "Enter") {
          if (activeIndex > -1) {
            e.preventDefault();
            items[activeIndex].dispatchEvent(new Event('mousedown'));
          }
        }
      };
      function updateActive(items, idx) {
        items.forEach((item, i) => {
          if (i === idx) item.classList.add('autocomplete-active');
          else item.classList.remove('autocomplete-active');
        });
      }
      input.onblur = function() {
        setTimeout(() => { list.style.display = 'none'; }, 200);
      };
      input.onchange = function() {
        const val = this.value.trim().toLowerCase();
        const nameKey = customerFields.name;
        const customer = customerList.find(c => (c[nameKey] || "").toLowerCase() === val);
        if (customer) fillCustomerDetails(customer);
      };
    }

    // DASHBOARD: Fetch and Render Complaints
    async function fetchComplaints() {
      const tbody = document.getElementById('complaintsTableBody');
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#aaa;">Loading...</td></tr>`;
      try {
        const res = await fetch(SHEETDB_API + "?sort_by=Timestamp&sort_order=desc");
        const data = await res.json();
        allComplaints = data;
        renderComplaintsTable(data);
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="5" style="color:red;text-align:center;">Failed to load complaints</td></tr>`;
      }
    }

    // Render complaint rows
    function renderComplaintsTable(list) {
      const tbody = document.getElementById('complaintsTableBody');
      if (!Array.isArray(list) || list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#aaa;">No complaints found.</td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      list.forEach((c, i) => {
        const status = c[complaintFields.status] || 'Pending';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c[complaintFields.name] || ''}</td>
          <td>${c[complaintFields.complaintType] || ''}</td>
          <td><span class="complaint-status ${status}">${status}</span></td>
          <td style="font-size:13px;">${c[complaintFields.timestamp] || ''}</td>
          <td>
            <button class="action-btn" title="Mark as resolved"${status === 'Resolved' ? ' disabled' : ''} data-index="${i}">
              <i class="material-icons">${status === 'Pending' ? 'done' : 'check_circle'}</i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      // Add action listeners
      tbody.querySelectorAll('.action-btn:not([disabled])').forEach(btn => {
        btn.onclick = function() {
          const idx = +btn.getAttribute('data-index');
          markComplaintResolved(idx);
        }
      });
    }

    // Mark as resolved (update in SheetDB by row id)
    async function markComplaintResolved(idx) {
      const complaint = allComplaints[idx];
      if (!complaint || complaint[complaintFields.status] === "Resolved") return;
      // Find row id
      const rowId = complaint.id || complaint.ID || complaint.__id || complaint.rowid || null;
      if (!rowId) {
        alert("Cannot resolve: Row ID not available.");
        return;
      }
      // PATCH status to Resolved
      try {
        await fetch(`${SHEETDB_API}/id/${rowId}`, {
          method: 'PATCH',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({data: {[complaintFields.status]: "Resolved"}})
        });
        fetchComplaints();
      } catch (e) {
        alert("Failed to update status.");
      }
    }

    // Dashboard search/filter
    function filterComplaints() {
      let filtered = allComplaints.slice();
      const nameVal = document.getElementById('searchName').value.trim().toLowerCase();
      const typeVal = document.getElementById('searchType').value.trim().toLowerCase();
      const statusVal = document.getElementById('searchStatus').value;
      if (nameVal) filtered = filtered.filter(c => (c[complaintFields.name]||'').toLowerCase().includes(nameVal));
      if (typeVal) filtered = filtered.filter(c => (c[complaintFields.complaintType]||'').toLowerCase().includes(typeVal));
      if (statusVal) filtered = filtered.filter(c => (c[complaintFields.status]||'Pending') === statusVal);
      renderComplaintsTable(filtered);
    }
    document.getElementById('searchName').oninput =
    document.getElementById('searchType').oninput =
    document.getElementById('searchStatus').onchange = filterComplaints;

    document.getElementById('refreshComplaintsBtn').onclick = function() {
      fetchComplaints();
    };

    // Initial load
    fetchCustomerList();
    fetchComplaints();
  </script>
</body>
</html>
